
## Telemt-SSU
[Telemt](https://github.com/telemt/telemt) с поддержкой Selective Socks Upstream.

Данный форк сделан как пример и MVP для [этого патча](https://github.com/unuunn/telemt-ssu/tree/feat/scoped-routing).  
Позволяет делать связи `telemt.user > upstream`,  `telemt.user > socks`

В связке с [3proxy-fup](https://github.com/unuunn/3proxy-fup) это является готовым решением для запуска Telemt в режиме Fair Usage Policy (*пакет трафика на максимальной скорости, с ограничением скорости после окончания*).  


### Как появился
MTProxy сам по себе не поддерживает ограничений соединений/трафика, и при реализации их сбросом соединения клиент моментально пытается переключиться, но если лимит все еще активен (*например блок по трафику*), сервер откинет соединение, в ответ на это, клиент не остановится пока его не закрыть, открывая соединения с пугающей частотой.  
Максимально подробно я описал это тут: [#94](https://github.com/telemt/telemt/issues/94)

Подход к решению этой проблемы я вижу в возможности не рвать соединение, а замедлять его.  
Таким образом появляется возможность установить связь `соединение=пользователь` и доступными средствами прокинуть ее дальше по архитектуре компонентов.

Для этого я сделал небольшой патч, который позволяет привязать к конкретному пользователю определенный socks `upstream`, плюс аутентификация на прокси будет с именем пользователя в telemt.
Благодаря этому появляется возможность управлять трафиком пользователя в показателях объем/скорость/время.

*Я очень **не** люблю rust, за его синтаксис. Учитывайте, что писать на нем, больше пришлось, чем хотелось*

### Логика работы
Если у пользователя имя начинается с префикса `scope_`, он будет выделен в отдельную группу, которая для подключения будет использовать `upstreams`, у которых этот пользователь указан в свойстве `scopes`, (*без префикса `scope_`, для удобства*).  
Подключение к такому прокси-апстриму будет выполняться с именем пользователя в качестве имени и пароля для прокси.
Апстримы, имеющие/не имеющие `scopes` не пересекаются.
(*для scoped пользователей только scoped апстримы, и наоборот*)

Работает это все только режиме direct (`use_middle_proxy = false
`) и только с `socks4/socks5` прокси.

#### Пример конфигурации
Эта конфигурация-пример, для режима [Fair Usage Policy в связке с 3proxy-fup](https://github.com/unuunn/3proxy-fup), тут отражены только основные изменения. Полную версию конфига берите из оригинального [README_ORIG.md](./README_ORIG.md) 
```bash
[general]
use_middle_proxy = false
# Поддерживается только direct режим

[access.users]
# format: "username" = "32_hex_chars_secret"
tguser1 = "00000000000000000000000000000000"
scope_hello = "10000000000000000000000000000000"
scope_unlim = "20000000000000000000000000000000"
scope_undef = "30000000000000000000000000000000"

# === Upstreams & Routing ===
# Стандартный апстрим для НЕ обычных users
[[upstreams]]
type = "direct"
enabled = true
weight = 1

# Стандартный апстрим для обычных users
[[upstreams]]
type = "socks5"
address = "192.168.1.1:1080"
enabled = true
weight = 10

# Апстрим только для users.scope_* -- "hwllo,world,hello,unlim"
[[upstreams]]
type = "socks5"
address = "127.0.0.1:1081"
enabled = true
weight = 10
username = "telemt"
password = "telemt"
# Тк, прокси с авторизацией, надо указать username/password,
# они переопределятся на USER:USER у scope_USER
# например: scope_hello будет ходить на прокси как hello:hello итд

scopes = "hwllo,world,hello,unlim"
# в scopes через запятую перечислены scope_* пользователи
```
В конфиге выше для прокси заведено 4 пользователя, 
и 3 апстрима:
* прямой, имеет низкий вес, будет выбран как резервный
* через прокси, для обычных пользователей
* через прокси, для `scope_*` пользователей

пользователи:
* **tguser1** :  обычный пользователь, будет использовать два апстрима без `scopes`
* **scope_hello** : определен в `scopes`, будет подключаться к upstream как `hello:hello`  
* **scope_unlim** : определен в `scopes`, будет подключаться к upstream как `unlim:unlim`  
  `scopes = "hwllo,world,hello,unlim"`
* **scope_undef** : нигде не определен, не удастся подключиться

--- unuunn (c) 2o26

##### оригинальный [README_ORIG.md](./README_ORIG.md) от telemt
